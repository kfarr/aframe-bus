<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>View from the Sky • A-Frame</title>
    <meta name="description" content="Hello, WebVR! • A-Frame">
    <script src="https://aframe.io/releases/0.9.2/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/mayognaise/aframe-gif-shader/dist/aframe-gif-shader.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/feiss/aframe-environment-component/dist/aframe-environment-component.min.js"></script>
    <script src="https://unpkg.com/aframe-slice9-component/dist/aframe-slice9-component.min.js"></script>
    <script src="https://unpkg.com/aframe-orbit-controls@1.2.0/dist/aframe-orbit-controls.min.js"></script>
    <script src="https://unpkg.com/aframe-template-component@^3.1.1/dist/aframe-template-component.min.js"></script>
    <script src="https://unpkg.com/aframe-log-component/dist/aframe-log-component.min.js"></script>
    <script src="https://unpkg.com/aframe-look-at-component@0.8.0/dist/aframe-look-at-component.min.js"></script>
    <script src="https://unpkg.com/aframe-state-component@6.6.0/dist/aframe-state-component.min.js"></script>

    <script src="https://unpkg.com/aframe-meshline-component@0.2.1/dist/aframe-meshline-component.min.js"></script>

    <script src="forward.js"></script>
    <script src="clock.js"></script>

    <script>

      AFRAME.registerState({
        initialState: {
          busPeeps: 0,
          stopPeeps: 3
        },

        handlers: {
          decreaseBusPeeps: function (state, action) {
            state.busPeeps -= 1;
            // if < 0 then make 0 (or throw exception?)
          },

          increaseBusPeeps: function (state, action) {
            state.busPeeps += 1;
            // stop at bus capacity
            // if state.busPeeps > action.capacity {state.busPeeps = action.capacity }
          },

          decreaseStopPeeps: function (state, action) {
            state.stopPeeps -= 1;
            // if < 0 then make 0 (or throw exception?)
          },

          increaseStopPeeps: function (state, action) {
            state.increaseStopPeeps += 1;
            // to what limit?
          }

        }
      });

      // passengers board the bus if bus is within threshold distance of busstop
      AFRAME.registerComponent('boarding', {
        schema: {
          delay: {type: 'number', default: 1000},
          target: {type: 'string', default: "bus-stop"},
          distance: {type: 'number', default: 2},
          capacity: {type: 'number', default: 4},
          busPeeps: {type: 'number', default: 0},
          stopPeeps: {type: 'number', default: 0}
        },
        init: function () {
          this.throttledFunction = AFRAME.utils.throttle(this.everySecond, 1000, this);
          this.comparisonVector = new THREE.Vector3();
          this.positionDelta = Number(this.data.distance) + 1;
          this.targetEl = document.querySelector("#" + this.data.target);
          this.positionThis = new THREE.Vector3();
          this.positionTarget = new THREE.Vector3();
        },
        everySecond: function() {
          // if distance between this element and the target element are less than distance
          // if current passengers is less than capacity
          // subtract 1 passenger from target bus stop
          // add 1 passenger to bus
          console.log(this.el.object3D.getWorldPosition(this.positionThis));
          console.log(this.targetEl.object3D.getWorldPosition(this.positionTarget));

          this.comparisonVector.subVectors(this.positionThis, this.positionTarget);
          this.positionDelta = this.comparisonVector.length();
          console.log(this.positionDelta);

          // if bus is close enough to bus stop
          if (this.positionDelta < Number(this.data.distance)) {
            var busFull = Number(this.data.busPeeps) == Number(this.data.capacity);
            // console.log(this.data.busPeeps);
            // console.log(this.data.capacity);
            // console.log(busFull);
            if (!busFull) {
              var stopEmpty = Number(this.data.stopPeeps) == 0;
              console.log(stopEmpty);
              console.log(this.data.stopPeeps);
              if (!stopEmpty) {
                AFRAME.scenes[0].emit('increaseBusPeeps');
                AFRAME.scenes[0].emit('decreaseStopPeeps');
                document.querySelector("#roberta").removeAttribute("animation__board");
                document.querySelector("#roberta").setAttribute("animation__board", "property: object3D.position.x; easing: linear; from: 0; to: -4; dur: 1000;");

                console.log("1 PEEPS BOARDED");
              } else {
                console.log("Stop Empty");
              }
            } else {
              console.log("Bus Full");
            }
          }
        },
        tick: function(){
          this.throttledFunction();  // Called once a second.
        },
      });

      AFRAME.registerComponent('position-log', {
        schema: {

        },
        init: function() {
          this.throttledFunction = AFRAME.utils.throttle(this.everySecond, 1000, this);
//          this.last = this.el.getAttribute('position');
          this.lastPosition = new THREE.Vector3();
          this.lastPosition.copy(this.el.object3D.position);
          this.velocity = new THREE.Vector3();
          this.speed = 0;
          this.lastSpeed = 0;
          this.passengers = 0;
          this.acceleration = 0;
        },
        everySecond: function() {

          AFRAME.log("******* ENTITY CONSOLE LOG *******\nCurrent Position");
          AFRAME.log(this.el.object3D.position);
          // AFRAME.log("Previous Position");
          // AFRAME.log(this.lastPosition);
          AFRAME.log("Velocity (m/s)");
          this.velocity.subVectors(this.el.object3D.position, this.lastPosition);
          AFRAME.log(this.velocity);

          this.speed = this.velocity.length()
          AFRAME.log("Speed: " + this.speed + " m/s");
          this.acceleration = this.speed - this.lastSpeed;
          AFRAME.log("Acceleration: " + this.acceleration + " m/s^2");

          AFRAME.log("Passengers: " + AFRAME.scenes[0].systems.state.state.busPeeps);


          // AFRAME.log("Speed via Math");
          // this.speed = Math.sqrt(Math.pow(this.velocity.getComponent(0), 2) + Math.pow(this.velocity.getComponent(1), 2) + Math.pow(this.velocity.getComponent(2), 2));
          // AFRAME.log(this.speed);

          this.lastPosition.copy(this.el.object3D.position);
          this.lastSpeed = this.speed;

        },
        tick: function(){
          this.throttledFunction();  // Called once a second.
        },
      });

      // hack for orbit-controls and look-at component to play nicely together https://github.com/supermedium/superframe/issues/200
      AFRAME.registerComponent('orbit-look-at-hack', {
        tick: function () {
          lookCubeHack.setAttribute('position', mainCamHack.getObject3D('camera').position);
        }
      });

  </script>

  </head>
  <body>
    <a-scene stats background="color: #ECECEC">
      <a-entity id="mainCamHack" orbit-controls="target: 0.0001 0 0; minDistance: 0.5; maxDistance: 180; initialPosition: 0 28 0"> </a-entity>
      <a-entity id="lookCubeHack" orbit-look-at-hack geometry="" static-body="shape: box" position="0 0 0" scale="1 1 1"></a-entity>

      <a-entity environment="preset: starry;
                       ground: canyon;
                       groundYScale: 4;
                       groundTexture: squares;
                       groundColor: #606060;
                       groundColor2: #505050;
                       dressing:none;
                       dressingColor: #477a49;
                       grid: none;
                       shadow: false;
                       fog: 0;
                       lighting: none;
                       lightPosition: 0 0.01 -0.46" scale="10 10 10">
</a-entity>
      <a-assets>
          <img id="destination-queens" src="images/Q9ALimitedOrangeLED.gif" />
          <img id="sky" src="images/sky3.jpg" />
          <script id="bustemplate" type="text/html">
            <a-plane class="bus-front" src="url(images/bus-front.png)" material="alphaTest: 0.5;" position="0 0.181 5.979" rotation="-8 0 0" width="2.59" height="2.7186" shadow="receive:false"></a-plane>
            <a-plane class="bus-top" src="url(images/${topurl}.png)" material="alphaTest: 0.5;" position="0 1.485 -0.1" rotation="-90 -90 0" width="11.879" height="2.59" shadow="receive:false"></a-plane>
            <a-plane class="bus-right" src="url(images/bus-right.png)" material="alphaTest: 0.5;" position="-1.295 0 0" rotation="0 -90 0" width="12.459" height="3.001" shadow="receive:false"></a-plane>
            <a-plane class="bus-left" src="url(images/bus-left.png)"  material="alphaTest: 0.5;" position="1.295 0 0" rotation="0 90 0" width="12.459" height="3.001" shadow="receive:false"></a-plane>
            <a-plane class="bus-back" src="url(images/bus-back.png)" material="alphaTest: 0.5;" position="0 0.181 -6.040" rotation="0 180 0" width="2.59" height="2.7186" shadow="receive:false"></a-plane>
            <a-plane class="bus-shadow" src="url(images/bus-shadow.png)" material="alphaTest: 0.5;transparent:true;metalness:1;roughness:1;" position="0 -1.489 -0.1" rotation="-90 -90 0" width="11.879" height="2.59" scale="1.2 1.2 0"></a-plane>

            <a-plane class="destination-led-front" position="0 1.23 5.84" rotation="-7.2 0 0" height="0.19" width="1.66" material="shader:gif;src:#destination-queens;"></a-plane>
            <a-plane class="destination-led-side" position="-1.3 0.98 3.75" rotation="0 -90 0" height="0.15" width="1.32" material="shader:gif;src:#destination-queens;"></a-plane>
            <a-text class="destination-led-back" position="-0.44 1.34 -6.06" value="Q9A" color="#ffbf00" text="font:dejavu" rotation="0 180 0" scale="0.9 0.9 0.9"></a-text>

            <a-image class="lensflare-headlight-left" src="url(images/light_PNG14436.png)" material="alphaTest:0" position="1.08 -0.72 6.18" scale="1.5 1.5 0"></a-image>
            <a-image class="lensflare-headlight-right" src="url(images/light_PNG14436.png)" material="alphaTest:0" position="-1.11 -0.72 6.18" scale="1.5 1.5 0"></a-image>

            <a-image class="lensflare-tail-light-left" src="url(images/tail-light.png)" position="1.07 -0.16 -6.06" rotation="0 180 0" scale="2 2 0"></a-image>
            <a-image class="lensflare-tail-light-right" src="url(images/tail-light.png)" position="-1.08 -0.16 -6.06" rotation="0 180 0" scale="2 2 0"></a-image>

            <a-entity class="light-tail-light-right" light="type:spot;angle:17.35;penumbra:0.39;color:#ff0000;intensity:5.5;distance:20" position="-1.1 -0.8 -4.22"></a-entity>
            <a-entity class="light-tail-light-left" light="type:spot;angle:17.35;penumbra:0.39;color:#ff0000;intensity:5.5;distance:20" position="1.1 -0.8 -4.22"></a-entity>

            <a-entity class="light-headlight-left" light="type:spot;angle:17.35;penumbra:0.39;color:#ffffff;intensity:14.2;distance:20" rotation="0 180 0" position="1.1 -0.9 4.82"></a-entity>
            <a-entity class="light-headlight-right" light="type:spot;angle:17.35;penumbra:0.39;color:#ffffff;intensity:14.2;distance:20" rotation="0 180 0" position="-1.1 -0.9 4.82"></a-entity>
          </script>

          <a-asset-item id="new-bus" src="models/new-bus/GLTF/BUS.gltf"></a-asset-item>

      </a-assets>


      <a-entity id="bus" position-log wasd-controls="acceleration: 260;" position="0 0 10">
        <a-text id="busPeepsLabel" look-at="#lookCubeHack" position="0 6 3" rotation="0 270 0" scale="15 15 15" bind__value="busPeeps" color="cyan" font="monoid"></a-text>

        <a-ring id="bus-door-marker" color="cyan" position="2 0.5 -5.315" radius-inner="0.4" radius-outer="0.5" rotation="-90 0 0" material="shader:flat"
        bind__boarding="busPeeps: busPeeps; stopPeeps: stopPeeps" boarding="target: bus-stop-1-marker">
        </a-ring>

        <a-entity id="log" look-at="#lookCubeHack" log="max: 10;" scale="6 6 6" geometry="primitive: plane;" material="color: #111; shader: flat" text="color: lightgreen" position="-6 3 0"></a-entity>

        <!-- <a-entity id="bus2" template="src: #bustemplate" data-topurl="bus-top" position="-6.3 1.5 0" rotation="0 0 0"  > -->
          <!-- <a-entity gltf-model="#new-bus" rotation="0 270 0" scale="0.4 0.4 0.4"></a-entity> -->
          <a-entity id="bus-model" template="src: #bustemplate" data-topurl="bus-top-4278" position="0 1.5 0" rotation="0 180 0" ></a-entity>

          <!-- <a-entity id="bus3" template="src: #bustemplate" data-topurl="bus-top-3959" position="0 1.5 -40" rotation="0 180 0" forward resetlt="position:0 1.5 50;trigger:-50"></a-entity> -->

      </a-entity>
      <!-- <a-entity id="bus" template="src: #bustemplate" data-topurl="bus-top-4278" position="0 1.5 0" rotation="0 180 0" forward resetlt="position:0 1.5 50;trigger:-50"></a-entity> -->
        <!-- <a-entity scale="5 5 5" id="bus2log" log="channel: foo" geometry="primitive: plane"></a-entity> -->

      </a-entity>

      <!-- <a-entity id="bus3" template="src: #bustemplate" data-topurl="bus-top-3959" position="0 1.5 -40" rotation="0 180 0" forward resetlt="position:0 1.5 50;trigger:-50"></a-entity> -->
      <!-- <a-entity id="bus4" template="src: #bustemplate" position="-6.3 1.5 40" rotation="0 0 0" forward resetgt="position:-6.3 1.5 -50;trigger:50"></a-entity> -->

      <!-- <a-entity slice9="width: 2; height: 1; left: 20; right: 43; top: 20; bottom: 43; src: images/tooltip.png" position="0 1 -2"></a-entity> -->

      <a-entity id="model-streetlight" gltf-model="models/streetlightmodel.gltf" position="-3.6 -1.9 8.2" rotation="0 180 0" scale="1.5 1.5 1.5"></a-entity>
      <a-entity id="light-streetlight" light="type:spot;angle:57.85;penumbra:0.19" position="-3 4.5 7" rotation="-90 0 0"></a-entity>

      <a-entity id="messageboard" position="0 0 -12">
        <a-entity id="messageboard-pole" gltf-model="models/streetlightmodel.gltf" position="4.5 -1.9 3.4" scale="1.5 1.5 1.5"></a-entity>
        <a-entity id="messageboard-sign" material="color:black" geometry="depth:0.33;width:3.54" position="1.961 4.160 4.66" ></a-entity>
        <a-entity clock="font: sourcecodepro; color: #ffbf00; position: 0.381 4.03 4.859"></a-entity>
        <a-text position="0.381 4.36 4.859" value="Howard St Closed at 3rd" color="#ffbf00" font="monoid"></a-text>
      </a-entity>

      <a-entity meshline="lineWidth: 2; path: -2 -1 0, 0 -2 0, 2 -1; color: #E20049" position="0 10 0"></a-entity>

      <!-- <a-entity id="sidewalk" geometry="primitive:plane;height:10;width:30" position="7.72 0.26 0" rotation="270 0 90" material="src:images/cobblestone-sidewalk.jpg;repeat:18 6;color:#f4fff7;metalness:1;roughness:0.84"></a-entity> -->
      <a-entity class="bus-stop" id="bus-stop-1" position="4.5 0 25">
        <!-- <a-entity text="value: 0" position="0 10 0" scale="5 5 5"></a-entity> -->

        <a-text id="stopPeepLabel" look-at="#lookCubeHack" position="2 6 0" rotation="0 270 0" scale="15 15 15" bind__value="stopPeeps" color="yellow" font="monoid"></a-text>


        <a-entity class="minis">
          <a-obj-model
            id="bob"
            animation__1="property: object3D.rotation.z; easing: linear; from: -45; to: 45; dir: alternate; dur: 500; loop: true"
            animation__2="property: object3D.position.y; easing: linear; from: 0.2; to: 1; dir: alternate; dur: 250; loop: true"
            position="0 0.2 0" rotation="0 270 0" scale="0.1 0.1 0.1" src="models/city-builder-obj/chr_worker1.obj" mtl="models/city-builder-obj/chr_worker1.mtl"></a-obj-model>
          <a-obj-model
            id="roberta"
            animation__1="property: object3D.rotation.z; easing: linear; from: -45; to: 45; dir: alternate; dur: 500; loop: true"
            animation__2="property: object3D.position.y; easing: linear; from: 0.2; to: 1; dir: alternate; dur: 250; loop: true"
            position="0 0.2 -1" rotation="0 270 0" scale="0.1 0.1 0.1" src="models/city-builder-obj/chr_worker2.obj" mtl="models/city-builder-obj/chr_worker2.mtl"></a-obj-model>
          <a-obj-model
            id="tom"
            animation__1="property: object3D.rotation.z; easing: linear; from: -45; to: 45; dir: alternate; dur: 500; loop: true"
            animation__2="property: object3D.position.y; easing: linear; from: 0.2; to: 1; dir: alternate; dur: 250; loop: true"
            position="0 0.2 1" rotation="0 270 0" scale="0.1 0.1 0.1" src="models/city-builder-obj/chr_worker3.obj" mtl="models/city-builder-obj/chr_worker3.mtl"></a-obj-model>


        </a-entity>

        <a-entity id="bus-stop-sidewalk" geometry="primitive:plane;height:5;width:15" position="1.5 0.26 3" rotation="270 0 90" material="src:images/cobblestone-sidewalk.jpg;repeat:9 3;color:#f4fff7;metalness:1;roughness:0.84"></a-entity>

        <a-image class="bus-stop-stencil" src="url(images/stop-bus.png)" material="alphaTest:0;opacity:0.5;" rotation="270 270 90" position="-4.7 0.02 3" scale="6 8 6"></a-image>

        <a-entity id="bus-stop-shelter" gltf-model="models/ccFO2EGGIq9-bus-stop/bust stop 1.gltf" position="1 0.25 0" rotation="-90 0 0" scale="0.001 -0.001 0.001"></a-entity>
        <a-entity id="bus-stop-advert" geometry="primitive:plane;height:2.5;width:2" position="0.24 1.53 2.07" material="src:images/carrot-advert-lighting.jpg;shader:flat" id="carrot-advert"></a-entity>

        <!-- <a-ring id="mark" position="0 0.5 0" scale="100 100 100" material="shader:flat" color="yellow" rotation="-90 0 0" radius-inner="0.01" radius-outer="0.02" animation="property: scale; from: 100 100 100; to: 200 200 200; dir: alternate; dur: 1000; loop: true"> -->
          <a-ring id="bus-stop-1-marker" color="yellow" position="-2.536 0.5 -0.932"
          animation__1="property: radius-inner; from: 2; to: 7; dir: alternate; dur: 1000; loop: true"
          animation__2="property: radius-outer; from: 2.2; to: 9; dir: alternate; dur: 1000; loop: true"
          rotation="-90 0 0" material="shader:flat" radius-inner="3" radius-outer="4" >
          </a-ring>

          <a-ring id="bus-stop-1-marker-door-zone" color="yellow" position="-2.536 0.5 -0.932"
          rotation="-90 0 0" material="shader:flat" radius-inner="1.8" radius-outer="2" >
          </a-ring>
          <!-- <a-ring color="yellow" material="shader:flat" radius-inner="0.05" radius-outer="0.06">
          <a-animation
              attribute="scale"
              from="1 1 1"
              to="3 3 3"
              direction="alternate"
              dur="1000"
              repeat="indefinite"></a-animation>
          </a-ring> -->
        <!-- </a-ring> -->

      </a-entity>



      <a-entity id="lane-northbound">
        <a-entity id="street1" position="2.2 0.25 0" rotation="90 0 0" scale="0.5 0.5 0.5">
          <a-entity gltf-model="models/street-7aKNh-4MGdK/scene.gltf" scale="0.001 0.001 0.001"></a-entity>
        </a-entity>

        <a-entity id="street2" position="2.2 0.25 -28.68" rotation="90 0 0" scale="0.5 0.5 0.5">
          <a-entity gltf-model="models/street-7aKNh-4MGdK/scene.gltf" scale="0.001 0.001 0.001"></a-entity>
        </a-entity>

        <a-entity id="street3" position="2.2 0.25 28.68" rotation="90 0 0" scale="0.5 0.5 0.5">
          <a-entity gltf-model="models/street-7aKNh-4MGdK/scene.gltf" scale="0.001 0.001 0.001"></a-entity>
        </a-entity>
      </a-entity>

      <a-entity id="lane-southbound" position="-6.3 0 0" rotation="0 180 0">
        <a-entity id="street1" position="2.2 0.25 0" rotation="90 0 0" scale="0.5 0.5 0.5">
          <a-entity gltf-model="models/street-7aKNh-4MGdK/scene.gltf" scale="0.001 0.001 0.001"></a-entity>
        </a-entity>

        <a-entity id="street2" position="2.2 0.25 -28.68" rotation="90 0 0" scale="0.5 0.5 0.5">
          <a-entity gltf-model="models/street-7aKNh-4MGdK/scene.gltf" scale="0.001 0.001 0.001"></a-entity>
        </a-entity>

        <a-entity id="street3" position="2.2 0.25 28.68" rotation="90 0 0" scale="0.5 0.5 0.5">
          <a-entity gltf-model="models/street-7aKNh-4MGdK/scene.gltf" scale="0.001 0.001 0.001"></a-entity>
        </a-entity>
      </a-entity>

      <a-entity id="median" geometry="primitive:plane;height:1.3;width:85.9" position="-3.08 0.26 0" rotation="270 0 90" material="src:images/cobblestone-sidewalk.jpg;repeat:30 1;color:#f4fff7;metalness:1;roughness:0.84"></a-entity>
      <a-entity light="intensity:0.6;castShadow:true" position="-0.5 1 1"></a-entity>
      <a-entity id="ambient" light="color:#BBB;type:ambient;intensity:0.1"></a-entity>
    </a-scene>
  </body>
</html>
